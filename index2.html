<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Server Browser</title>
    <script src="js/handlebars.min.js"></script>
    <script src="js/jquery-1.11.3.min.js"></script>
    
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <script src="js/bootstrap.min.js"></script>
	
	<!--<script src="js/dewRcon.js"></script>-->
	
    <style>
    #bg {
      position: fixed; 
      top: 0; 
      left: 0; 
        
      /* Preserve aspect ratio */
      min-width: 100%;
      min-height: 100%;
    }
    
	#serverlist {
		position: absolute;
		top: 5px;
		bottom: 0;
		left: 5px;
		right: 1px;
		width: 85%;
	}

	#serverinfo {
		position: absolute;
		top: 10;
		bottom: 0;
		right: 0;
		width: 27%;
	}
	
	
    </style>
</head>
<body>
<!--
<img src="images/bg.jpg" id="bg" alt="">
-->
<div id="container">

        <div id="serverList" class="serverlist"> </div>
        <div id="serverInfo" class="col-md-3 serverinfo"> </div>

</div>

<script id="server-panel-template" type="text/x-handlebars-template">
    {{#if  map}}
    <img src="images/maps/{{mapFile}}.png" alt="{{map}}" class="img-responsive">
    <h3>{{ name }} </h3>
	{{#if variant}}
    <h4>{{ variant }} / {{ map }}</h4>
	{{else}}
    <h4>{{ map }}</h4>
	{{/if}}
    <h3>{{hostPlayer}}</h3>
        <div class="panel-heading">
            <h4><em>Players:</em> {{ players.length }}/{{ maxPlayers }} || {{status}}</h4> 
                <ul>
                {{#each players}}
                {{#if name}}
                <li>{{this.name}} - {{kills}}/{{deaths}}/{{assists}}</li>
                {{/if}}
                {{/each}}
                </ul>
    {{else}}
        <h3>Do not join<h3>
    {{/if}}
</script>

<script id="server-listinfo-template" type="text/x-handlebars-template">
        <div class="col-sm-4">{{ name }}</div>
        <div class="col-sm-4">{{ numPlayers }} / {{ maxPlayers }}</div>
        <div class="col-sm-4">{{ variant }}</div>        
</script>
<script id="server-list-template" type="text/x-handlebars-template">
    <table class="table table-bordered table-hover" id="serverlist{{ i }}">
		<thead>
			<th><center>IP</center></th>
			<th></th>
			<th><center>Location</center></th>
			<th><center>Game Data</center></th>
		</thead>
		<tbody>
    {{#each servers}}
		<tr>
			<td class="col-md-2"><a href="#" onclick="updateServerInfo({{i}});">{{ serverIP }}</a></td>
			<td class="col-sm-1"><a href="#" onclick="console.log({{serverIP}});">JOIN</a></td>
			<td class="col-md-2"><span id="region{{ i }}">Anywhere, United States</span></td>
			<td class="col-md-6" id="serverid{{ i }}"></td>
		</tr>
    {{/each}}
		</tbody>
    </table>
</script>

<script>
        var serverList = {
        servers: []
        };
        
        var serverTemplateSource = $("#server-panel-template").html();
        var serverTemplate = Handlebars.compile(serverTemplateSource);
        
        var serverListTemplateSource = $("#server-list-template").html();
        var serverListTemplate = Handlebars.compile(serverListTemplateSource);
        
        var serverListInfoTemplateSource = $("#server-listinfo-template").html();
        var serverListInfoTemplate = Handlebars.compile(serverListInfoTemplateSource);
        
        var VerifyIPRegex = /^(?:(?:2[0-4]\d|25[0-5]|1\d{2}|[1-9]?\d)\.){3}(?:2[0-4]\d|25[0-5]|1\d{2}|[1-9]?\d)(?:\:(?:\d|[1-9]\d{1,3}|[1-5]\d{4}|6[0-4]\d{3}|65[0-4]\d{2}|655[0-2]\d|6553[0-5]))?$/;
       
        var jqhxr = $.getJSON( "http://192.99.124.162/list", null)
                .done(function( data ) {
                        for(var i = 0; i < data.result.servers.length; i++)
                        {
                                var serverIP = data.result.servers[i];
                                //because sometimes jackasses inject into the server list

                                if(VerifyIPRegex.test(serverIP)){
                                        serverList.servers.push({serverIP, i});
                                        (function(i, serverIP) {
                                            var jqhxrGeoInfo = $.getJSON("http://www.telize.com/geoip/" + serverIP.substr(0, serverIP.indexOf(':')), null )
                                            .done(function(data) {
                                                    $("#region" + i).html(data.region + ", " + data.country);
                                                });
                                            var jqhrxServerInfo = $.getJSON("http://" + serverIP, null )
                                            .done(function(serverInfo) {
                                                    serverInfo["serverId"] = i;
                                                    var html = serverListInfoTemplate(serverInfo);
                                                    $("#serverid" + i).html(html);
                                                    for (var j = 0; j < serverList.servers.length; j++)
                                                    {
                                                        if (serverList.servers[j]["i"] == i)
                                                        {
                                                            serverList.servers[j] = serverInfo;
                                                        }
                                                    }
                                                    console.log(serverInfo);
                                            });
                                        })(i, serverIP);
                                } else {
                                    console.log("Invalid IP, skipping.");
                                }
                        }
                        var listHtml = serverListTemplate(serverList);
                        $("#serverList").html(listHtml);

                for (var j = 0; j < serverList.servers.length; j++)
                {
                        console.log(serverList.servers[j]);
                }
                });
    function updateServerInfo(i) {
        var html = serverTemplate(serverList.servers[i]);
        $("#serverInfo").html(html)
    }
	function joinServer(ip) {
		dewRcon.send('connect ' + ip);
    }
</script>

</body>
</html>